/**
 * Format a list of options from a storage model for use in X-editable
 *
 * @since 1.0
 *
 * @param array options List of options, can be nested (1 level max). Options have their key as the input value and their value as the input label. Parents have string 'label' and array 'options' of options.
 * @return array List of options with parents with 'text' and 'children' and options with 'id' and 'text'
 */function cacie_options_format_editable(e){var t=[];if(typeof e=="undefined")return t;for(var n=0;n<e.length;n++){var r;if(typeof e[n].options!="undefined"){r={text:e[n].label,children:[]};for(var i in e[n].options)r.children.push({value:e[n].options[i].value,id:e[n].options[i].value,text:e[n].options[i].label})}else r={value:e[n].value,id:e[n].value,text:e[n].label};t.push(r)}return t}function cacie_get_jquery_boostrap_date_format(e){e=e.replace("yy","R");e=e.replace("y","yy");e=e.replace("R","yyyy");return e}function cacie_esc_regex(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function cacie_is_float(e){var t="";"decimal_point"in woocommerce_admin&&woocommerce_admin.decimal_point&&(t="|"+cacie_esc_regex(woocommerce_admin.decimal_point));var n=new RegExp("^[0-9]+((."+t+")[0-9]+)?$");return e.match(n)}function cacie_init(){window.xeditables=[];window.cacie_edit_enabled=1;var e=jQuery("#the-list"),t=CACIE_Columns,n=CACIE_Items;for(var r in t){var i=t[r];i.column_name=r;if(i.edit=="on"&&i.addon_cacie.editable){if(typeof i.addon_cacie.editable.type=="undefined"||i.addon_cacie.editable.type==="")continue;var s=i.addon_cacie.editable.type,o,u;o="cacie_edit_"+s;jQuery(".column-"+r,e).each(function(){var e,t=jQuery(this).parents("tr").attr("id"),u=parseInt(t.substr(t.lastIndexOf("-")+1),10);if(!(u in n))return!0;e=n[u];var a;r in e.columndata&&(a=e.columndata[r].revisions[0]);if(typeof a=="undefined"||typeof a.errors!="undefined")return!0;(s=="select2_dropdown"||s=="select2_tags")&&a.length===0&&(a=[]);e.columndata[r].value=a;jQuery(this).addClass("cacie-editable-container cacie-editable-"+s);jQuery(this).wrapInner('<span class="inner cacie-editable"></span>');var f=jQuery(this).find(".inner");f.cacie_handle_value(i,e);f.cacie_handle_actions(i,e);f[o](i,e)})}}}function cacie_enable(){jQuery("#cacie-toggle-edit").addClass("active");typeof window.xeditables=="undefined"?cacie_init():jQuery(window.xeditables).editable("enable");jQuery("#the-list").addClass("cacie-enabled");window.cacie_edit_enabled=1}function cacie_disable(){jQuery("#cacie-toggle-edit").removeClass("active");jQuery(window.xeditables).editable("disable");window.cacie_edit_enabled=0;jQuery("#the-list").removeClass("cacie-enabled")}jQuery.fn.cacie_show_message=function(e,t){typeof t=="undefined"?t="":t!="info"&&t!="error"&&t!="success"&&(t="");var n=jQuery("<div />");n.addClass("alert");t&&n.addClass("alert-"+t);n.append('<button type="button" class="close" data-dismiss="alert">&times;</button>');n.append(e);jQuery(this).after(n)};jQuery.fn.cacie_after_save=function(e,t,n){var r=jQuery(this);typeof n!="undefined"&&r.cacie_set_value(e,t,n);r.removeClass("bg-transition");r.cacie_handle_value(e,t);r.cacie_handle_actions(e,t);r.cacie_remove_ajax_loading(e,t);jQuery(document).trigger("cacie_after_save",e,t,n)};jQuery.fn.cacie_handle_value=function(e,t){var n=jQuery(this),r=n.cacie_get_value(e,t),i;r?i=!1:i=!0;e.addon_cacie.editable.type=="media"&&r=="false"&&(i=!0);if(i){n.parents("td").removeClass("cacie-nonempty");n.parents("td").addClass("cacie-empty")}else{n.parents("td").addClass("cacie-nonempty");n.parents("td").removeClass("cacie-empty")}};jQuery.fn.cacie_add_ajax_loading=function(e,t){var n=jQuery(this),r=n.parents("td").find(".cacie-editable");switch(e.type){case"title":case"name":r.siblings(".post-state").length&&(r=r.siblings(".post-state").eq(0))}r.after('<div class="spinner cacie-ajax-loading" />')};jQuery.fn.cacie_remove_ajax_loading=function(e,t){var n=jQuery(this);n.parents("td").find(".cacie-ajax-loading").remove()};jQuery.fn.cacie_restore_revision=function(e,t,n){var r=jQuery(this);t.columndata[e.column_name].current_revision=n;var i=CACIE_Items[t.ID].columndata[e.column_name].revisions,s=CACIE_Items[t.ID].columndata[e.column_name].current_revision;if("is_xeditable"in e.addon_cacie.editable&&e.addon_cacie.editable.is_xeditable){var o=r.cacie_get_target(e);r.cacie_add_ajax_loading(e,t);o.editable("setValue",i[s],!0);o.editable("submit")}else r.cacie_savecolumn(e,t,i[s],!1);r.cacie_handle_actions(e,t)};jQuery.fn.cacie_get_target=function(e){var t=jQuery(this);typeof e.addon_cacie.editable.js!="undefined"&&typeof e.addon_cacie.editable.js.selector!="undefined"&&t.find(e.addon_cacie.editable.js.selector).length&&(t=t.find(e.addon_cacie.editable.js.selector));return t};jQuery.fn.cacie_get_value=function(e,t){return t.columndata[e.column_name].value};jQuery.fn.cacie_set_value=function(e,t,n){t.columndata[e.column_name].value=n};jQuery.fn.cacie_edit_text=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"text",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_float=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"text",value:n.cacie_get_value(e,t),validate:function(e){if(!cacie_is_float(e))return qie_i18n.errors.invalid_float}},e,t)};jQuery.fn.cacie_edit_wc_price=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"wc_price",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_wc_usage=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"wc_usage",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_wc_stock=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"wc_stock",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_dimensions=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"dimensions",value:n.cacie_get_value(e,t),validate:function(e){if(!cacie_is_float(e.length)||!cacie_is_float(e.width)||!cacie_is_float(e.height))return qie_i18n.errors.invalid_floats}},e,t)};jQuery.fn.cacie_edit_number=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"number",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_password=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"password",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_email=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"email",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_checkboxlist=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"checklist"},e,t)};jQuery.fn.cacie_edit_textarea=function(e,t){var n=jQuery(this);n.cacie_xeditable({type:"textarea",value:n.cacie_get_value(e,t)},e,t)};jQuery.fn.cacie_edit_select=function(e,t){var n=jQuery(this),r=n.cacie_get_value(e,t),i=e.addon_cacie.editable.options;n.cacie_xeditable({type:"select",value:r,source:cacie_options_format_editable(i)},e,t)};jQuery.fn.cacie_edit_select2_dropdown=function(e,t){var n=e.addon_cacie.editable.options,r=jQuery(this),i={type:"select2",showbuttons:!1,source:cacie_options_format_editable(n),select2:{width:200}},s=t.columndata[e.column_name].editable;if(typeof e.addon_cacie.editable.ajax_populate!="undefined"&&e.addon_cacie.editable.ajax_populate){args={source:"",select2:{width:200,minimumInputLength:1,initSelection:function(e,t){var n=[];if(typeof s.formattedvalue!="undefined")for(var r in s.formattedvalue)n.push({id:r,text:s.formattedvalue[r]});n.length==1?t(n[0]):n.length>0&&t(n)},ajax:{url:ajaxurl,dataType:"json",quietMillis:100,data:function(n,r){return{plugin_id:"cpac",action:"cacie_get_options",searchterm:n,column:e.column_name,storage_model:CACIE_Storage_Model,item_id:t.ID}},results:function(e,t){if(e.success)return{results:cacie_options_format_editable(e.data)};r.data("editable").input.$input.select2("close");r.data("editable").container.$form.editableform("error",e.data);return{results:[]}}}}};i=jQuery.extend(i,args)}typeof e.addon_cacie.editable.multiple!="undefined"&&e.addon_cacie.editable.multiple&&(i.select2.multiple=!0);jQuery(this).cacie_xeditable(i,e,t);typeof e.addon_cacie.editable.ajax_populate!="undefined"&&e.addon_cacie.editable.ajax_populate&&jQuery(this).on("shown",function(){var e=r.data("editable").input.$input;e.on("change",function(){s.formattedvalue=[];var t=e.select2("data");if(typeof t.id!="undefined")s.formattedvalue[t.id]=t.text;else for(var n in t)s.formattedvalue[t[n].id]=t[n].text})})};jQuery.fn.cacie_edit_select2_tags=function(e,t){var n=jQuery(this),r=e.addon_cacie.editable.options,i=n.cacie_get_value(e,t);"false"==i&&(i="");n.cacie_xeditable({type:"select2",value:i,select2:{width:200,tags:cacie_options_format_editable(r)}},e,t)};jQuery.fn.cacie_edit_togglable=function(e,t){var n=jQuery(this),r=e.addon_cacie.editable.options;jQuery(this).on("click",function(){if(!window.cacie_edit_enabled||!r)return;var i=n.cacie_get_value(e,t),s=r.length,o=0,u;for(var a in r)if(i==r[a].label){o=r[a].value;break}if(typeof e.addon_cacie.editable.required!="undefined"&&e.addon_cacie.editable.required&&o!==0){n.cacie_show_message(qie_i18n.errors.field_required);return}u=r[(o+1)%s].label;n.cacie_savecolumn(e,t,u)})};jQuery.fn.cacie_edit_media=function(e,t){var n=jQuery(this);n.cacie_edit_attachment(e,t)};jQuery.fn.cacie_edit_attachment=function(e,t){var n=jQuery(this);n.on("click",function(r){r.preventDefault();if(!window.cacie_edit_enabled)return;var i=n.cacie_get_value(e,t);jQuery.isArray(i)||(i=[i]);var s={title:"Change image",button:{text:"Set as image"},multiple:typeof e.addon_cacie.editable.multiple!="undefined"&&e.addon_cacie.editable.multiple};if(typeof e.addon_cacie.editable.attachment!="undefined"&&typeof e.addon_cacie.editable.attachment.library!="undefined"){s.library={};typeof e.addon_cacie.editable.attachment.library.uploaded_to_post!="undefined"&&(s.library.uploadedTo=t.ID);typeof e.addon_cacie.editable.attachment.library.type!="undefined"&&(s.library.type=e.addon_cacie.editable.attachment.library.type)}"js"in e.addon_cacie.editable&&(s=jQuery.extend(s,e.addon_cacie.editable.js));var o=wp.media(s);o.on("open",function(){var e=o.state().get("selection");i.forEach(function(t){attachment=wp.media.attachment(t);attachment.fetch();e.add(attachment?[attachment]:[])})});o.on("select",function(){var r=o.state().get("selection").toJSON(),i=o.options.multiple,s=[];for(var u in r){var a=r[u];s.push(a.id)}1===s.length&&!i&&(s=s[0]);n.cacie_savecolumn(e,t,s)});typeof e.addon_cacie.editable.attachment!="undefined"&&typeof e.addon_cacie.editable.attachment.disable_select_current!="undefined"&&e.addon_cacie.editable.attachment.disable_select_current&&o.on("ready",function(){setTimeout(function(){},1)});o.open()})};jQuery.fn.cacie_edit_date=function(e,t){var n=jQuery(this),r=n.cacie_get_value(e,t);if(r){r=[r.slice(0,4),"-",r.slice(4)].join("");r=[r.slice(0,7),"-",r.slice(7)].join("")}n.attr("data-date",r);n.attr("data-date-format","yyyy-mm-dd");n.datepicker().on("changeDate",function(r){var i=new Date(r.date),s=i.yyyymmdd();n.cacie_savecolumn(e,t,s)});Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),n=this.getDate().toString();return e+(t[1]?t:"0"+t[0])+(n[1]?n:"0"+n[0])}};jQuery.fn.cacie_edit_combodate=function(e,t){var n=jQuery(this);jQuery(this).on("click",null,function(){if(!window.cacie_edit_enabled)return;var r=n.cacie_get_value(e,t),i=e.date_save_format;n.datepicker()})};jQuery.fn.cacie_edit_checklist=function(e,t){var n=jQuery(this),r=n.cacie_get_value(e,t),i=e.addon_cacie.editable.options;"false"==r&&(r="");n.cacie_xeditable({type:"checklist",value:r,source:cacie_options_format_editable(i)},e,t)};jQuery.fn.cacie_xeditable=function(e,t,n){var r=jQuery(this),i={url:ajaxurl,params:{plugin_id:"cpac",action:"cacie_column_save",storage_model:CACIE_Storage_Model,column:t.column_name},pk:n.ID,value:jQuery(this).cacie_get_value(t,n),placement:"bottom",mode:"popup",emptytext:""};e=jQuery.extend(i,e);typeof t.addon_cacie.editable.js!="undefined"&&(e=jQuery.extend(e,t.addon_cacie.editable.js));typeof t.addon_cacie.editable.placeholder!="undefined"&&(e.placeholder=t.addon_cacie.editable.placeholder);var s=[];typeof t.addon_cacie.editable.maxlength!="undefined"&&s.push({key:"maxlength",value:parseInt(t.addon_cacie.editable.maxlength,10)});typeof t.addon_cacie.editable.range_min!="undefined"&&s.push({key:"min",value:parseFloat(t.addon_cacie.editable.range_min,10)});typeof t.addon_cacie.editable.range_max!="undefined"&&s.push({key:"max",value:parseFloat(t.addon_cacie.editable.range_max,10)});typeof t.addon_cacie.editable.range_step!="undefined"&&s.push({key:"step",value:parseFloat(t.addon_cacie.editable.range_step,10)});if(s.length){var o="";for(var u in s)o+=s[u].key+'="'+jQuery("<div />").text(s[u].value).html()+'"';switch(t.addon_cacie.editable.type){case"number":e.tpl='<input type="number" '+o+">";break;case"text":e.tpl='<input type="text" '+o+">";break;case"textarea":e.tpl="<textarea "+o+"></textarea>"}}typeof t.addon_cacie.editable.required!="undefined"&&t.addon_cacie.editable.required&&(e.validate=function(e){var n=!0;switch(t.addon_cacie.editable.type){case"select":if(!e||e=="null")n=!1;break;default:e.length||(n=!1)}if(!n)return qie_i18n.errors.field_required});var a=r.cacie_get_target(t);a.on("save",function(e,i){r.cacie_store_revision(t,n,i.newValue);r.cacie_after_save(t,n,i.newValue)});if(typeof t.addon_cacie.editable.display_ajax=="undefined"||t.addon_cacie.editable.display_ajax){e.display=function(){};e.success=function(e){e.success&&r.html(e.data.value);r.cacie_after_save(t,n);if(typeof e.data!="undefined"&&typeof e.data.rawvalue!="undefined")return{newValue:e.data.rawvalue}}}else e.success=function(e){r.cacie_after_save(t,n)};t.addon_cacie.editable.is_xeditable=!0;var f=r;if(typeof t.addon_cacie.editable.js!="undefined"&&typeof t.addon_cacie.editable.js.selector!="undefined"){f=r.find(t.addon_cacie.editable.js.selector);r.removeClass("cacie-editable");f.addClass("cacie-editable")}window.xeditables.push(f);r.editable(e)};jQuery.fn.cacie_store_revision=function(e,t,n){var r=CACIE_Items[t.ID].columndata[e.column_name].revisions,i=CACIE_Items[t.ID].columndata[e.column_name].current_revision,s=r.length-i-1;for(var o=0;o<s;o++)CACIE_Items[t.ID].columndata[e.column_name].revisions.pop();CACIE_Items[t.ID].columndata[e.column_name].revisions.push(n);CACIE_Items[t.ID].columndata[e.column_name].current_revision++;jQuery(this).cacie_handle_actions(e,t)};jQuery.fn.cacie_savecolumn=function(e,t,n,r){var i=jQuery(this);i.cacie_set_value(e,t,n);i.addClass("bg-transition");r=typeof r=="undefined"||r;r&&jQuery(this).cacie_store_revision(e,t,n);i.cacie_add_ajax_loading(e,t);jQuery.post(ajaxurl,{plugin_id:"cpac",action:"cacie_column_save",storage_model:CACIE_Storage_Model,column:e.column_name,pk:t.ID,value:n},function(n){if(n.success){i.html(n.data.value);typeof n.data.itemdata!="undefined"&&(t.columndata[e.column_name].itemdata=n.data.itemdata)}i.cacie_after_save(e,t)},"json")};jQuery.fn.cacie_handle_actions=function(e,t){var n,r,i,s,o,u;n=jQuery(this);r=n.parent().find(".cacie-cell-actions");r.remove();n.parent().find(".cacie-edit, .cacie-undo, .cacie-redo, .cacie-clear").remove();r=jQuery('<div class="cacie-cell-actions" />');el_edit=jQuery('<a href="#" class="cacie-cell-action cacie-edit" title="'+qie_i18n.edit+'" />');i=jQuery('<a href="#" class="cacie-cell-action cacie-undo" title="'+qie_i18n.undo+'" />');s=jQuery('<a href="#" class="cacie-cell-action cacie-redo" title="'+qie_i18n.redo+'" />');o=jQuery('<a href="#" class="cacie-cell-action cacie-clear" title="'+qie_i18n.delete+'"/>');i.hide();s.hide();o.hide();r.append(s);r.append(i);e.addon_cacie.editable.clear_button&&r.prepend(o);switch(e.type){case"title":case"name":r.prepend(el_edit);n.parents("td").find(e.addon_cacie.editable.js.selector).after(r);break;case"coupon_code":r.prepend(el_edit);n.parents("td").find(e.addon_cacie.editable.js.selector).after(r);n.parents("td").find(".row-actions a").click(function(e){e.stopPropagation()});break;default:switch(e.addon_cacie.editable.type){case"attachment":if(t.columndata[e.column_name].itemdata.url){u=jQuery('<a href="'+t.columndata[e.column_name].itemdata.url+'" class="cacie-cell-action cacie-download" target="_blank" title="'+qie_i18n.download+'"/>');r.prepend(u)}r.prepend(el_edit);n.parents("td").find(".cacie-editable").after(r);break;case"media":r.prepend(el_edit);i.before('<div class="cacie-separator" />');s.before('<div class="cacie-separator" />');if(typeof e.addon_cacie.editable.multiple!="undefined"&&e.addon_cacie.editable.multiple){n.parents("td").addClass("cacie-multiple");o.remove();n.parents("td").find(".cacie-item").each(function(){var r=jQuery('<div class="cacie-item-actions" />'),i=jQuery('<a href="#" class="cacie-cell-action cacie-delete" title="'+qie_i18n.delete+'"/>');r.append(i);i.on("click",function(e,t){return function(){var r=jQuery(this).parents(".cacie-item").attr("data-cacie-id"),i=n.cacie_get_value(e,t);jQuery.isArray(i)&&(i=jQuery.grep(i,function(e){return e!=r}));n.cacie_savecolumn(e,t,i);return!1}}(e,t));jQuery(this).append(r)});n.parents("td").find(".cacie-editable").append(r)}else n.parents("td").find(".cacie-editable").append(r);break;default:r.prepend(el_edit);n.parents("td").find(".cacie-editable").after(r)}}el_edit.on("click",function(e,t){return function(t){t.preventDefault();t.stopPropagation();n.cacie_get_target(e).trigger("click")}}(e,t));i.on("click",function(e,t){return function(r){r.preventDefault();r.stopPropagation();n.cacie_restore_revision(e,t,t.columndata[e.column_name].current_revision-1)}}(e,t));s.on("click",function(e,t){return function(r){r.preventDefault();r.stopPropagation();n.cacie_restore_revision(e,t,t.columndata[e.column_name].current_revision+1)}}(e,t));o.on("click",function(e,t){return function(r){n.cacie_savecolumn(e,t,"");r.stopPropagation()}}(e,t));var a=CACIE_Items[t.ID].columndata[e.column_name].revisions,f=CACIE_Items[t.ID].columndata[e.column_name].current_revision,l=a[f];f<a.length-1?s.show():s.hide();f>0?i.show():i.hide();l?o.show():o.hide()};jQuery(document).ready(function(e){if(typeof CACIE_Columns=="undefined"||typeof CACIE_Items=="undefined")return;if(CACIE_Columns.length===0||CACIE_Items.length===0)return;jQuery(".tablenav.top .actions:last").append('<a href="javascript:;" id="cacie-toggle-edit" class="add-new-h2">'+qie_i18n.inline_edit+"</a>");e("#cacie-toggle-edit").on("click",function(e){window.cacie_edit_enabled?cacie_disable():cacie_enable();jQuery.post(ajaxurl,{plugin_id:"cpac",action:"cacie_editability_state_save",value:window.cacie_edit_enabled,storage_model:CACIE_Storage_Model});e.preventDefault()});CACIE.inline_edit.active===!0&&cacie_enable()});